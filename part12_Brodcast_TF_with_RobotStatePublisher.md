### How Robot State Publisher and URDF Work Together
Launch our previous URDF File using 
```
ros2 launch urdf_tutorial display.launch.py model:=my_robot.urdf
```
We already know that, to output the tf tree as pdf,
```
ros2 run tf2_tools view_frames -o my_robot_frames
```
my_robot_frames = output file name
Output Tree is,
![alt text](https://github.com/Nabilphysics/ros2/blob/main/images/my_robot_frame_tf.png)

If we see what is going on using rqt_graph
```
rqt_graph
```
we will see,
![alt text](https://github.com/Nabilphysics/ros2/blob/main/images/rqt_graph_tf.png)

If we want to see topics in terminal
```
ros2 topic list
```
OUTPUT:
```
/joint_states
/parameter_events
/robot_description
/rosout
/tf
/tf_static
```
Here we can see that, /robot_state_publisher node is publishing to /tf topic. /robot_state_publisher node is already an existing node in ROS. All we have to do is to start it and provide the urdf to it. </br>
The question is where is the URDF? To see this,
```
ros2 node list
```
OUTPUT:
```
/joint_state_publisher
/robot_state_publisher
/rqt_gui_py_node_40913
/rviz2
/transform_listener_impl_562c6fc4b8e0
```
We have /robot_state_publisher node. To see the parameters of this node,
```
ros2 param list /robot_state_publisher
```
OUTPUT:
```
frame_prefix
  ignore_timestamp
  publish_frequency
  qos_overrides./joint_states.subscription.depth
  qos_overrides./joint_states.subscription.history
  qos_overrides./joint_states.subscription.reliability
  qos_overrides./parameter_events.publisher.depth
  qos_overrides./parameter_events.publisher.durability
  qos_overrides./parameter_events.publisher.history
  qos_overrides./parameter_events.publisher.reliability
  qos_overrides./tf.publisher.depth
  qos_overrides./tf.publisher.durability
  qos_overrides./tf.publisher.history
  qos_overrides./tf.publisher.reliability
  qos_overrides./tf_static.publisher.depth
  qos_overrides./tf_static.publisher.history
  qos_overrides./tf_static.publisher.reliability
  robot_description
  use_sim_time
```
We have the robot_description parameter here.<br>
To see the robot_description parameter
```
ros2 param get /robot_state_publisher robot_description
```
OUTPUT:
```xml
String value is: <?xml version="1.0" ?>
<!-- =================================================================================== -->
<!-- |    This document was autogenerated by xacro from my_robot.urdf                  | -->
<!-- |    EDITING THIS FILE BY HAND IS NOT RECOMMENDED                                 | -->
<!-- =================================================================================== -->
<robot name="my_robot">
  <material name="green">
    <color rgba="0.0 0.5 0.0 1.0"/>
  </material>
  <material name="blue">
    <color rgba="0.0 0.0 0.5 1.0"/>
  </material>
  <material name="grey">
    <color rgba="0.0 0.5 0.5 1.0"/>
  </material>
  <link name="base_footprint">
       
    </link>
  <link name="base_link">
    <visual>
      <geometry>
        <box size="0.6 0.4 0.2"/>
      </geometry>
      <origin rpy="0 0 0" xyz="0 0 0.1"/>
      <material name="blue"/>
    </visual>
  </link>
  <link name="right_wheel_link">
    <visual>
      <geometry>
        <cylinder length="0.05" radius="0.1"/>
      </geometry>
      <origin rpy="1.57 0.0 0.0" xyz="0.0 0.0 0.0"/>
      <material name="grey"/>
    </visual>
  </link>
  <link name="left_wheel_link">
    <visual>
      <geometry>
        <cylinder length="0.05" radius="0.1"/>
      </geometry>
      <origin rpy="1.57 0.0 0.0" xyz="0.0 0.0 0.0"/>
      <material name="grey"/>
    </visual>
  </link>
  <link name="caster_wheel_link">
    <visual>
      <geometry>
        <sphere radius="0.05"/>
      </geometry>
      <origin rpy="0.0 0.0 0.0" xyz="0.0 0.0 0.0"/>
      <material name="grey"/>
    </visual>
  </link>
  <joint name="base_joint" type="fixed">
    <origin rpy="0 0 0" xyz="0.0 0.0 0.1"/>
    <parent link="base_footprint"/>
    <child link="base_link"/>
  </joint>
  <joint name="base_right_wheel_joint" type="continuous">
    <origin rpy="0 0 0" xyz="-0.15 -0.225 0.0"/>
    <parent link="base_link"/>
    <child link="right_wheel_link"/>
    <axis xyz="0.0 1.0 0.0"/>
  </joint>
  <joint name="base_left_wheel_joint" type="continuous">
    <origin rpy="0 0 0" xyz="-0.15 0.225 0.0"/>
    <parent link="base_link"/>
    <child link="left_wheel_link"/>
    <axis xyz="0.0 1.0 0.0"/>
  </joint>
  <joint name="base_caster_wheel_joint" type="fixed">
    <origin rpy="0.0 0.0 0.0" xyz="0.2 0.0 -0.05"/>
    <parent link="base_link"/>
    <child link="caster_wheel_link"/>
  </joint>
</robot>
```
It means that we start the robot_state_publisher node and we need to provide the URDF as a parameter, and this parameter will be the robot description. </br>
So /robot_state_publisher node also publishes URDF to /robot_description topic.</br>
The second input /robot_state_publisher topic is taking is /joint_state . The joint state is the value of each joint is a particular time. </br> 
To see /joint_states topic
```
ros2 topic echo /joint_states
```
OUTPUT:
```
header:
  stamp:
    sec: 1690791333
    nanosec: 386751494
  frame_id: ''
name:
- base_right_wheel_joint
- base_left_wheel_joint
position:
- -0.5604601294004192
- 3.141592653589793
velocity: []
effort: []
```
or we can see in
```
rqt
```
Joint State Publisher here is a fake node. In a real robot we will get value from Encoder. 
So in summary, we have our urdf file here first. What we need to do then is we will need to start the node robot State publisher and we will need to pass the urdf to the node by using a parameter then this robot state publisher needs first the urdf and state for each joint published on a joint state topic. </br>

And by knowing the state for each joint plus the data from the urdf, it will be able to compute the TF.

So it will compute the TF and it will publish on the TF topic.
URDF package is here doing all of that for us. 
So basically any app, any stack you're going to use to make your robot move in a certain way is going to need to use the TF topic.
To visualize,
(credit: https://www.udemy.com/course/ros2-tf-urdf-rviz-gazebo/)
![alt text](https://github.com/Nabilphysics/ros2/blob/main/images/ufdf_jointstate_to_tf.png)


## Run the Robot State Publisher with URDF in Terminal
Install xacro
```
sudo apt install ros-humble-xacro
```
Now run robot_state_publisher node from robot_state_publisher package and pass our URDF file as parameter
```
ros2 run robot_state_publisher robot_state_publisher --ros-args -p robot_description:="$(xacro my_robot.urdf)"
```
Now start joint_state_publisher executables from joint_state_publisher package, if not installed
```
sudo apt install ros-humble-joint-state-publisher-gui
```
run
```
ros2 run joint_state_publisher_gui joint_state_publisher_gui
```
run rviz
```
ros2 run rviz2 rviz2
```
from rviz,</br> 
Add > TF </br>
Fixed Frame> base_footprint<br>
Add RobotModel, then, RobotModel > Description Topic > /robot_description<br>
So in summary, We started robot_state_publisher and passed urdf as parameter, then started joint_state_publisher_gui, and rviz.</br>
Now save the config as "urdf_config.rviz" in home directory/folder

### RVIZ config save and load with command
If your config file is in home directory
```
ros2 run rviz2 rviz2 -d ~/urdf_config.rviz
```
Note: Before starting rviz you need to run joint_state_publisher and joint_state_publisher_gui from the previous section.

## Create a Robot Description Package to Install URDF
from home directory
```
mkdir ros2_ws
cd ros2_ws
mkdir src
```
If you do not have colcon 
```
sudo apt install python3-colcon-common-extensions
```
to source from ros2_ws directory,
```
source install/setup.bash
```
add to beshrc
```
gedit ~/.bashrc
```
and add below command after ros2 source
```
source ~/ros2_ws/install/setup.bash
```
Create robot description package
```
ros2 pkg create my_robot_description
```
```
cd my_robot_description
rm -rf include/ src/
mkdir urdf rviz
```
We are not gonna need incldue and src folder inside my_robot_description directory as we are not going to write c++ here, so , we have deleted those folders and created a folder named urdf and rviz</br>
Now we will move our previously created my_robot.urdf file to this urdf directory ,
```
cd
mv my_robot.urdf ros2_ws/src/my_robot_description/urdf/
cd ros2_ws/src/
code .
```
We have opened visual studio code.</br>
Inside my_robot_description directory we have CmakeList.txt. We are going to remove some code which are not necessary for us, so that CMakeLists.txt will look like this,
```cmake
cmake_minimum_required(VERSION 3.8)
project(my_robot_description)

if(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_CXX_COMPILER_ID MATCHES "Clang")
  add_compile_options(-Wall -Wextra -Wpedantic)
endif()

# find dependencies
find_package(ament_cmake REQUIRED)


ament_package()

```
Now we will install urdf (have to add in cmakelist.txt)
```cmake
cmake_minimum_required(VERSION 3.8)
project(my_robot_description)

if(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_CXX_COMPILER_ID MATCHES "Clang")
  add_compile_options(-Wall -Wextra -Wpedantic)
endif()

# find dependencies
find_package(ament_cmake REQUIRED)

install(
  DIRECTORY urdf
  DESTINATION share/${PROJECT_NAME}/
)

ament_package()

```
go to ros2_ws directory and
```
colcon build
```
You can see bunch of things created. To see our urdf file
```
cd ~/ros2_ws/install/my_robot_description/share/my_robot_description/urdf
```
## Write a launch file to start the Robot State Publisher with URDF
create a launch folder/directory inside my_robot_description. Also, add rviz and urdf folder. Save rviz config file inside rviz directory as "urdf_config.rviz" </br>
add launch in our CMakeLists.txt
```cmake
cmake_minimum_required(VERSION 3.8)
project(my_robot_description)

if(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_CXX_COMPILER_ID MATCHES "Clang")
  add_compile_options(-Wall -Wextra -Wpedantic)
endif()

# find dependencies
find_package(ament_cmake REQUIRED)

install(
  DIRECTORY urdf launch rviz
  DESTINATION share/${PROJECT_NAME}/
)

ament_package()

```
### XML Launch File
Create a file inside the launch folder name "display.launch.xml"
```xml
<launch>
    <let name="urdf_path" 
         value="$(find-pkg-share my_robot_description)/urdf/my_robot.urdf" />
    <let name="rviz_config_path"
         value="$(find-pkg-share my_robot_description)/rviz/urdf_config.rviz" />

   
    <node pkg="robot_state_publisher" exec="robot_state_publisher">
        <param name="robot_description" value="$(command 'xacro $(var urdf_path)')" />
    </node>
    
    <node pkg="joint_state_publisher_gui" exec="joint_state_publisher_gui">
    </node>

    <node pkg="rviz2" exec="rviz2" output="screen" args="-d $(var rviz_config_path)" />
  
</launch>
 
 <?ignore
    Reference for understanding:
    ros2 run robot_state_publisher robot_state_publisher --ros-args -p robot_description:="$(xacro my_robot.urdf)"
    ros2 run joint_state_publisher_gui joint_state_publisher_gui
    ros2 run rviz2 rviz2
?>
```
build using colcon build</br>
run
```
ros2 launch my_robot_description display.launch.xml
```
### Python Launch File
inside launch folder create a file name display.launch.py
```python
from launch import LaunchDescription
import os
from ament_index_python.packages import get_package_share_path
from launch_ros.parameter_descriptions import ParameterValue
from launch.substitutions import Command
from launch_ros.actions import Node

def generate_launch_description():
    
    
    # find the path of my_robot.urdf where it has installed
    urdf_path = os.path.join(get_package_share_path('my_robot_description'), 'urdf', 'my_robot.urdf')
    # rviz config path
    rviz_config_path = os.path.join(get_package_share_path('my_robot_description'), 'rviz', 'urdf_config.rviz')

    #parameter value (will be used in node)
    robot_description = ParameterValue(Command(['xacro ', urdf_path]), value_type=str)

    #Start Node robot_state_publisher
    #Reference: # Reference: ros2 run robot_state_publisher robot_state_publisher --ros-args -p robot_description:="$(xacro my_robot.urdf)"
    robot_state_publisher_node = Node(
        package="robot_state_publisher", 
        executable="robot_state_publisher",
        parameters=[{'robot_description': robot_description}]
        )

    #Start Node robot_state_publisher
    #Reference: ros2 run joint_state_publisher_gui joint_state_publisher_gui
    joint_state_publisher_gui_node = Node(
        package="joint_state_publisher_gui",
        executable="joint_state_publisher_gui"
    )
    
    #Start rviz node
    #Reference: ros2 run rviz2 rviz2
    rviz2_node = Node(
        package="rviz2",
        executable="rviz2",
        arguments=['-d', rviz_config_path]
        
    )
    
    
    return LaunchDescription([
        robot_state_publisher_node,
        joint_state_publisher_gui_node,
        rviz2_node
    ])
```















